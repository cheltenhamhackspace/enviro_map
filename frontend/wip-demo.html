<!DOCTYPE html>
<html lang="en">

<head>
	<base target="_top">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>Cheltenham Hackspace - enviro_map Demo</title>

	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
		integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
		integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"
		integrity="sha512-ZwR1/gSZM3ai6vCdI+LVF1zSq/5HznD3ZSTk7kajkaj4D292NLuduDCO1c/NT8Id+jE58KYLKT7hXnbtryGmMg=="
		crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment-with-locales.min.js"
		integrity="sha512-4F1cxYdMiAW98oomSLaygEwmCnIP38pb4Kx70yQYqRwLVCs3DbRumfBq82T08g/4LJ/smbFGFpmeFlQgoDccgg=="
		crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1"></script>
	<style>
		html,
		body {
			height: 100%;
			margin: 0;
		}

		.leaflet-container {
			height: 400px;
			width: 600px;
			max-width: 100%;
			max-height: 100%;
		}

		table,
		th,
		td {
			border: 1px solid black;
			border-collapse: collapse;
		}

		tr:nth-child(even) {
			background-color: #D6EEEE;
		}

		.leaflet-tooltip-pane .text {
			color: rgb(0, 0, 0);
			font-weight: bold;
			background: transparent;
			border: 0;
			box-shadow: none;
			font-size: 1.5em;
		}
	</style>


</head>

<body>
	<h1> Using placeholder and randomly generated data right now </h1>
	<div id="map" style="width: 100%; height: 70%;"></div>
	<canvas id="pmChart" style="width: 100%; height: 20%;"></canvas>

	<script>
		var pmChart = new Chart("pmChart", {
			type: "line",
			data: {
				labels: ["Jan", "", "", "", "Feb", "", "", "", "Mar", "", "", "", "Apr", "", "", "", "May", "", "", "", "Jun", "", "", "", "Jul", "", "", "", "Aug", "", "", "", "Sep", "", "", "", "Oct", "", "", "", "Nov", "", "", "", "Dec", "", "", ""],
				datasets: [
					{
						label: "PM1",
						data: Array.from({ length: 48 }, () => Math.floor(Math.random() * 500))
					},
					{
						label: "PM2.5",
						data: Array.from({ length: 48 }, () => Math.floor(Math.random() * 250))
					},
					{
						label: "PM10",
						data: Array.from({ length: 48 }, () => Math.floor(Math.random() * 50))
					}
				]
			},
			options: {
				plugins: {
					title: {
						display: true,
						text: 'Country Wide Average',
					}
				},
				scales: {
					x: {
						type: "time",
						distribution: "linear"
					}
				}
			}
		});

		async function getTimeSeriesNode(e) {
			var uuid = e.sourceTarget.options.uuid
			console.log(uuid)
			apiUrl = `https://ostbn1wyte.execute-api.eu-west-1.amazonaws.com/v1/sensor/${uuid}/PM2_5`
			const request = await fetch(apiUrl, { method: "GET" });
			const response = await request.json();
			updateGraph(e.sourceTarget.options.name, response)
		}

		function updateGraph(title, data) {
			if (pmChart) {
				console.log(data)
				pmChart.data.datasets = [{ backgroundColor: "rgba(54, 162, 235, 0.5)", borderColor: "rgb(54, 162, 235)", label: "PM2.5", data: data }]
				pmChart.options.scales.x.min = data[0].x
				pmChart.options.scales.x.max = data[data.length - 1].x
				//pmChart.data.labels = data.times
				// for (datasetId in pmChart.data.datasets) {
				// 	pmChart.data.datasets[datasetId].data = Array.from({ length: 48 }, () => Math.floor(Math.random() * 500 / (datasetId + 1)))
				// }
				pmChart.options.plugins.title.text = title
				pmChart.update()
			}
		}

	</script>

	<script>
		const testData = {
			"sensors": [
				{
					"name": "test node 1",
					"uuid": "test-node-1-uuid",
					"location": [
						"51.8800",
						"-2.0700"
					],
					"pm1": "1",
					"pm2_5": "1",
					"pm10": "1",
					"temp": "1",
					"humid": "1"
				},
				{
					"name": "test node 2",
					"uuid": "test-node-2-uuid",
					"location": [
						"51.9100",
						"-2.0450"
					],
					"pm1": "2",
					"pm2_5": "2",
					"pm10": "2",
					"temp": "2",
					"humid": "2"
				},
				{
					"name": "test node 3",
					"uuid": "test-node-3-uuid",
					"location": [
						"51.9200",
						"-2.1150"
					],
					"pm1": "3",
					"pm2_5": "3",
					"pm10": "3",
					"temp": "3",
					"humid": "3"
				},
				{
					"name": "test node 4",
					"uuid": "test-node-4-uuid",
					"location": [
						"51.8850",
						"-2.1100"
					],
					"pm1": "4",
					"pm2_5": "400",
					"pm10": "4",
					"temp": "4",
					"humid": "4"
				},
				{
					"name": "test node 5",
					"uuid": "test-node-5-uuid",
					"location": [
						"51.8994",
						"-2.0783"
					],
					"pm1": "5",
					"pm2_5": "100",
					"pm10": "5",
					"temp": "5",
					"humid": "5"
				}
			]
		};

		// USE TEST DATA
		var sensorData = testData.sensors

		function getPMColour(sensor) {
			var greenLimit = 50,
				amberLimit = 100,
				redLimit = 150

			if (sensor.pm2_5 <= greenLimit) {
				return '#0f0'
			}
			else if (sensor.pm2_5 > greenLimit && sensor.pm2_5 <= amberLimit) {
				return '#f70'
			}
			else {
				return '#f00'
			}
		}

		const map = L.map('map').setView([51.8994, -2.0783], 13);

		const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
			maxZoom: 19,
			attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
		}).addTo(map);


		function printDebug(e) {
			console.log(e.sourceTarget.options.uuid);
		}

		// BEGIN HANDLE_TEST_DATA
		markers = []
		for (sensorId in sensorData) {
			// draw a circle for each item
			var circle = L.circleMarker(sensorData[sensorId].location, {
				color: getPMColour(sensorData[sensorId]),
				fillColor: getPMColour(sensorData[sensorId]),
				fillOpacity: 0.6,
				opacity: 1,
				radius: 20,
				uuid: sensorData[sensorId].uuid,
				name: sensorData[sensorId].name
			}).bindPopup(`<table>
							<tr>
								<td>Name</td>
								<td>${sensorData[sensorId].name}</td>
							</tr>
							<tr>
								<td>Temperature</td>
								<td>${sensorData[sensorId].temp}</td >
							</tr >
							<tr>
								<td>Humidity</td>
								<td>${sensorData[sensorId].humid}</td >
							</tr >
							<tr>
								<td>PM1</td>
								<td>${sensorData[sensorId].pm1}</td>
							</tr>
							<tr>
								<td>PM2.5</td>
								<td>${sensorData[sensorId].pm2_5}</td >
							</tr >
							<tr>
								<td>PM10</td>
								<td>${sensorData[sensorId].pm10}</td >
							</tr >
						</table >`).bindTooltip(sensorData[sensorId].pm2_5, { direction: 'center', className: 'text', permanent: true }).addTo(map).on('click', getTimeSeriesNode)
		};
		// END HANDLE_TEST_DATA

		function testFunc(e) {
			console.log(map.getBounds());
		}
		map.on('moveend', testFunc);

	</script>



</body>

</html>